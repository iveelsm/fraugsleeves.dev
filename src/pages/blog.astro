---
import { getCollection } from 'astro:content';
import NavigableLayout from '../layouts/navigable.astro';
import '../styles/blog-list.css';

const allBlogs = (await getCollection('blog')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

function formatDate(date: Date): string {
	return date.toLocaleDateString('en-US', {
		year: 'numeric',
		month: 'long',
		day: 'numeric'
	});
}
---
<NavigableLayout title="Blog">
	<div class="blog-container">
		<div class="filter-header" id="filter-header" style="display: none;">
			<span class="filter-label">Filtered by:</span>
			<span class="filter-tag" id="filter-tag-name"></span>
			<a href="/blog" class="filter-clear" aria-label="Clear filter" id="filter-clear">
				<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<line x1="18" y1="6" x2="6" y2="18"></line>
					<line x1="6" y1="6" x2="18" y2="18"></line>
				</svg>
			</a>
		</div>
		
		<p class="no-posts" id="no-posts" style="display: none;">No posts found.</p>
		
		<ul class="posts-list" id="posts-list">
			{allBlogs.map(post => (
				<li class="post-item" data-tags={JSON.stringify(post.data.tags || [])}>
					<a href={`/blog/${post.id}`} class="post-link">
						<span class="post-title">{post.data.title}</span>
						<span class="post-date">{formatDate(post.data.pubDate)}</span>
					</a>
					{post.data.description && (
						<p class="post-description">{post.data.description}</p>
					)}
					{post.data.tags && post.data.tags.length > 0 && (
						<div class="post-tags">
							{post.data.tags.map((tag: string) => (
								<a 
									href={`/blog?tag=${encodeURIComponent(tag)}`} 
									class="post-tag"
									data-tag={tag}
								>
									{tag}
								</a>
							))}
						</div>
					)}
				</li>
			))}
		</ul>
	</div>
</NavigableLayout>

<script is:inline>
(function() {
	function initTagFilter() {
		const params = new URLSearchParams(window.location.search);
		const tagFilter = params.get('tag');
		
		const filterHeader = document.getElementById('filter-header');
		const filterTagName = document.getElementById('filter-tag-name');
		const postsList = document.getElementById('posts-list');
		const noPosts = document.getElementById('no-posts');
		const postItems = document.querySelectorAll('.post-item');
		const tagLinks = document.querySelectorAll('.post-tag');
		
		if (!filterHeader || !filterTagName || !postsList || !noPosts) return;
		
		// Show/hide filter header
		if (tagFilter) {
			filterHeader.style.display = 'flex';
			filterTagName.textContent = tagFilter;
			document.title = `Blog - ${tagFilter}`;
		} else {
			filterHeader.style.display = 'none';
			document.title = 'Blog';
		}
		
		// Filter posts
		let visibleCount = 0;
		postItems.forEach(item => {
			const tags = JSON.parse(item.getAttribute('data-tags') || '[]');
			const isVisible = !tagFilter || tags.includes(tagFilter);
			item.style.display = isVisible ? '' : 'none';
			if (isVisible) visibleCount++;
		});
		
		// Show no posts message if needed
		if (visibleCount === 0) {
			noPosts.style.display = 'block';
			noPosts.textContent = tagFilter 
				? `No posts found for tag "${tagFilter}".`
				: 'No posts found.';
			postsList.style.display = 'none';
		} else {
			noPosts.style.display = 'none';
			postsList.style.display = '';
		}
		
		// Update active tag styling
		tagLinks.forEach(link => {
			const tag = link.getAttribute('data-tag');
			if (tag === tagFilter) {
				link.classList.add('active');
			} else {
				link.classList.remove('active');
			}
		});
	}
	
	// Run on page load
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initTagFilter);
	} else {
		initTagFilter();
	}
	
	// Re-run on Astro page transitions
	document.addEventListener('astro:page-load', initTagFilter);
	
	// Handle browser back/forward
	window.addEventListener('popstate', initTagFilter);
})();
</script>
