---
/**
 * Custom search component using Pagefind API
 * with expanding toolbar search bar style
 * and full-screen mobile search overlay
 */
import "../../styles/search.css";

import MobileOverlay from "./mobileOverlay.astro";
import SearchContainer from "./searchContainer.astro";
---

<SearchContainer />
<MobileOverlay />

<script is:inline>
	(function () {
		let pagefind = null;

		async function loadPagefind() {
			if (pagefind) return pagefind;
			try {
				pagefind = await import("/pagefind/pagefind.js");
				await pagefind.init();
				return pagefind;
			} catch (e) {
				console.error("Failed to load Pagefind:", e);
				return null;
			}
		}

		async function performSearch(
			query,
			resultsContainer,
			isOverlay = false,
		) {
			if (!query.trim()) {
				resultsContainer.innerHTML = "";
				if (!isOverlay) {
					resultsContainer
						.closest(".search-dropdown")
						?.classList.remove("visible");
				}
				return;
			}

			const pf = await loadPagefind();
			if (!pf) {
				resultsContainer.innerHTML =
					'<div class="search-no-results">Search unavailable</div>';
				if (!isOverlay) {
					resultsContainer
						.closest(".search-dropdown")
						?.classList.add("visible");
				}
				return;
			}

			const search = await pf.search(query);

			if (search.results.length === 0) {
				resultsContainer.innerHTML =
					'<div class="search-no-results">No results found</div>';
				if (!isOverlay) {
					resultsContainer
						.closest(".search-dropdown")
						?.classList.add("visible");
				}
				return;
			}

			const results = await Promise.all(
				search.results
					.slice(0, isOverlay ? 10 : 5)
					.map((r) => r.data()),
			);

			resultsContainer.innerHTML = results
				.map(
					(result) => `
			<a href="${result.url}" class="search-result">
				<div class="search-result-title">${result.meta?.title || result.meta?.name || result.title || result.url}</div>
				<div class="search-result-excerpt">${result.excerpt}</div>
			</a>
		`,
				)
				.join("");

			if (!isOverlay) {
				resultsContainer
					.closest(".search-dropdown")
					?.classList.add("visible");
			}
		}

		function debounce(fn, delay) {
			let timeout;
			return function (...args) {
				clearTimeout(timeout);
				timeout = setTimeout(() => fn.apply(this, args), delay);
			};
		}

		function isMobile() {
			return window.innerWidth <= 640;
		}

		function initSearch() {
			// Desktop elements
			const container = document.getElementById("search-container");
			const toggle = document.getElementById("search-toggle");
			const input = document.getElementById("search-input");
			const clearBtn = document.getElementById("search-clear");
			const dropdown = document.getElementById("search-dropdown");
			const resultsContainer = document.getElementById("search-results");

			// Mobile elements
			const overlay = document.getElementById("search-overlay");
			const overlayClose = document.getElementById(
				"search-overlay-close",
			);
			const overlayInput = document.getElementById(
				"search-overlay-input",
			);
			const overlayResults = document.getElementById(
				"search-overlay-results",
			);

			if (!container || !toggle) return;

			const debouncedDesktopSearch = debounce(
				(query) => performSearch(query, resultsContainer, false),
				200,
			);

			const debouncedMobileSearch = debounce(
				(query) => performSearch(query, overlayResults, true),
				200,
			);

			let isDesktopOpen = false;

			function openDesktopSearch() {
				isDesktopOpen = true;
				container.classList.add("search-open");
				toggle.style.opacity = "0";
				toggle.style.transform = "scale(0.8)";
				toggle.style.pointerEvents = "none";
				setTimeout(() => input?.focus(), 150);
			}

			function closeDesktopSearch() {
				isDesktopOpen = false;
				container.classList.remove("search-open");
				toggle.style.opacity = "1";
				toggle.style.transform = "scale(1)";
				toggle.style.pointerEvents = "auto";
				if (input) input.value = "";
				dropdown?.classList.remove("visible");
				if (resultsContainer) resultsContainer.innerHTML = "";
			}

			function openMobileSearch() {
				overlay?.classList.add("active");
				document.body.style.overflow = "hidden";
				setTimeout(() => overlayInput?.focus(), 150);
			}

			function closeMobileSearch() {
				overlay?.classList.remove("active");
				document.body.style.overflow = "";
				if (overlayInput) overlayInput.value = "";
				if (overlayResults) overlayResults.innerHTML = "";
			}

			// Toggle click - check if mobile or desktop
			toggle.addEventListener("click", () => {
				if (isMobile()) {
					openMobileSearch();
				} else {
					openDesktopSearch();
				}
			});

			// Desktop events
			clearBtn?.addEventListener("click", closeDesktopSearch);
			input?.addEventListener("input", (e) =>
				debouncedDesktopSearch(e.target.value),
			);

			// Mobile events
			overlayClose?.addEventListener("click", closeMobileSearch);
			overlayInput?.addEventListener("input", (e) =>
				debouncedMobileSearch(e.target.value),
			);

			// Close on outside click (desktop only)
			document.addEventListener("click", (e) => {
				if (isDesktopOpen && !container.contains(e.target)) {
					closeDesktopSearch();
				}
			});

			// Escape key closes both
			document.addEventListener("keydown", (e) => {
				if (e.key === "Escape") {
					if (isDesktopOpen) closeDesktopSearch();
					if (overlay?.classList.contains("active"))
						closeMobileSearch();
				}
			});

			// Handle resize - close appropriate search if viewport changes
			window.addEventListener(
				"resize",
				debounce(() => {
					if (isMobile() && isDesktopOpen) {
						closeDesktopSearch();
					}
					if (!isMobile() && overlay?.classList.contains("active")) {
						closeMobileSearch();
					}
				}, 100),
			);
		}

		if (document.readyState === "loading") {
			document.addEventListener("DOMContentLoaded", initSearch);
		} else {
			initSearch();
		}
	})();
</script>
