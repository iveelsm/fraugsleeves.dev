---
import "../styles/blog.css";

import NavigableLayout from "./navigable.astro";
import Header from "../components/blogs/header.astro";
import Sidebar from "../components/toc/sidebar.astro";

const { frontmatter, headings } = Astro.props;
const { minutesRead } = frontmatter;

const article = {
	publishedTime: frontmatter.pubDate
		? new Date(frontmatter.pubDate).toISOString()
		: undefined,
	authors: frontmatter.author ? [frontmatter.author] : undefined,
	tags: frontmatter.tags,
};
---

<NavigableLayout
	title={frontmatter.title}
	description={frontmatter.description}
	image={frontmatter.image}
	article={article}
	class="blog-layout"
>
	<Header
		title={frontmatter.title}
		description={frontmatter.description}
		date={frontmatter.date}
		minutesRead={minutesRead}
		author={frontmatter.author}
		editors={frontmatter.editors}
		tags={frontmatter.tags}
	/>

	<div class="blog-container">
		<Sidebar headings={headings} />
		<main class="post-content">
			<slot />
		</main>
	</div>

	<script>
		/**
		 * Initialize header collapse behavior on scroll
		 */
		function initHeaderCollapse() {
			const header = document.querySelector(".post-header-fixed");
			const collapseThreshold = 5; // Collapse summary/tags after minimal scroll
			const hideThreshold = window.innerHeight / 4; // Fully hide after quarter window

			const handleScroll = () => {
				if (window.scrollY > hideThreshold) {
					header?.classList.add("hidden");
					header?.classList.add("collapsed");
				} else if (window.scrollY > collapseThreshold) {
					header?.classList.remove("hidden");
					header?.classList.add("collapsed");
				} else {
					header?.classList.remove("hidden");
					header?.classList.remove("collapsed");
				}
			};

			window.addEventListener("scroll", handleScroll, { passive: true });
			handleScroll(); // Check initial state
		}

		/**
		 * Initialize scroll spy to highlight active TOC item
		 */
		function initScrollSpy() {
			const tocLinks = document.querySelectorAll(".article-toc a");
			const headings = document.querySelectorAll(
				"main h1[id], main h2[id], main h3[id], main h4[id]",
			);

			if (headings.length === 0 || tocLinks.length === 0) return;

			const observerOptions = {
				root: null,
				rootMargin: "-80px 0px -70% 0px",
				threshold: 0,
			};

			let activeId = "";

			const observerCallback = (entries) => {
				entries.forEach((entry) => {
					if (entry.isIntersecting) {
						activeId = entry.target.id;
						updateActiveLink();
					}
				});
			};

			const updateActiveLink = () => {
				tocLinks.forEach((link) => {
					link.classList.remove("active");
					const href = link.getAttribute("href");
					if (href === `#${activeId}`) {
						link.classList.add("active");
					}
				});
			};

			const observer = new IntersectionObserver(
				observerCallback,
				observerOptions,
			);
			headings.forEach((heading) => observer.observe(heading));
		}

		/**
		 * Initialize all blog post functionality
		 */
		function initBlogPost() {
			initHeaderCollapse();
			initScrollSpy();
		}

		if (document.readyState === "loading") {
			document.addEventListener("DOMContentLoaded", initBlogPost);
		} else {
			initBlogPost();
		}

		document.addEventListener("astro:page-load", initBlogPost);
	</script>
</NavigableLayout>
