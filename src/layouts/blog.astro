---
import "../styles/blog.css";

import NavigableLayout from "./navigable.astro";

import { Header } from "../components/blogs";
import { Sidebar } from "../components/toc";

const { frontmatter, headings } = Astro.props;
const { minutesRead } = frontmatter;

const article = {
	publishedTime: frontmatter.pubDate
		? new Date(frontmatter.pubDate).toISOString()
		: undefined,
	authors: frontmatter.author ? [frontmatter.author] : undefined,
	tags: frontmatter.tags,
};
---

<NavigableLayout
	title={frontmatter.title}
	description={frontmatter.description}
	image={frontmatter.image}
	article={article}
	class="blog-layout"
>
	<Header
		title={frontmatter.title}
		description={frontmatter.description}
		date={new Date(frontmatter.pubDate)}
		minutesRead={minutesRead}
		author={frontmatter.author}
		editors={frontmatter.editors}
		tags={frontmatter.tags}
	/>

	<div class="blog-container">
		<Sidebar headings={headings} />
		<main class="post-content">
			<slot />
		</main>
	</div>

	<script>
		/**
		 * Initialize scroll spy to highlight active TOC item
		 */
		function initScrollSpy() {
			const tocLinks = document.querySelectorAll(".article-toc a");
			const headings = document.querySelectorAll(
				"main h1[id], main h2[id], main h3[id], main h4[id]",
			);

			if (headings.length === 0 || tocLinks.length === 0) return;

			const observerOptions = {
				root: null,
				rootMargin: "-80px 0px -70% 0px",
				threshold: 0,
			};

			let activeId = "";

			const updateActiveLink = (id) => {
				tocLinks.forEach((link) => {
					link.classList.remove("active");
					const href = link.getAttribute("href");
					if (href === `#${id}`) {
						link.classList.add("active");
					}
				});
			};

			const observerCallback = (entries) => {
				entries.forEach((entry) => {
					if (entry.isIntersecting) {
						activeId = entry.target.id;
						updateActiveLink(activeId);
					}
				});
			};

			// Check if user has scrolled to the bottom of the page
			const checkIfAtBottom = () => {
				const scrollTop =
					window.scrollY || document.documentElement.scrollTop;
				const scrollHeight = document.documentElement.scrollHeight;
				const clientHeight = document.documentElement.clientHeight;

				// If we're within 50px of the bottom, highlight the last heading
				if (scrollTop + clientHeight >= scrollHeight - 50) {
					const lastHeading = headings[headings.length - 1];
					if (lastHeading && lastHeading.id !== activeId) {
						activeId = lastHeading.id;
						updateActiveLink(activeId);
					}
				}
			};

			const observer = new IntersectionObserver(
				observerCallback,
				observerOptions,
			);
			headings.forEach((heading) => observer.observe(heading));

			// Add scroll listener to detect bottom of page
			window.addEventListener("scroll", checkIfAtBottom, {
				passive: true,
			});
		}

		/**
		 * Initialize copyable heading anchor links
		 */
		function initHeadingAnchors() {
			const anchorLinks = document.querySelectorAll(
				".post-content .heading-anchor",
			);

			anchorLinks.forEach((anchor) => {
				anchor.addEventListener("click", async (e) => {
					e.preventDefault();
					const href = anchor.getAttribute("href");
					const url = new URL(href, window.location.href);
					url.hash = href;

					try {
						await navigator.clipboard.writeText(url.toString());
						anchor.classList.add("copied");

						// Update URL without scrolling
						history.pushState(null, "", href);

						// Remove the copied class after animation
						setTimeout(() => {
							anchor.classList.remove("copied");
						}, 1500);
						// eslint-disable-next-line  @typescript-eslint/no-unused-vars
					} catch (_err) {
						// Fallback: just navigate to the anchor
						window.location.hash = href;
					}
				});
			});
		}
		/**
		 * Initialize all blog post functionality
		 */
		function initBlogPost() {
			initScrollSpy();
			initHeadingAnchors();
		}

		if (document.readyState === "loading") {
			document.addEventListener("DOMContentLoaded", initBlogPost);
		} else {
			initBlogPost();
		}

		document.addEventListener("astro:page-load", initBlogPost);
	</script>
</NavigableLayout>
