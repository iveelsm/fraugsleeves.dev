---
import "../styles/blog.css";

import { Header } from "../components/blogs";
import { Sidebar } from "../components/toc";
import Searchable from "./searchable.astro";

const { frontmatter, headings } = Astro.props;
const { minutesRead } = frontmatter;

const article = {
	publishedTime: frontmatter.pubDate
		? new Date(frontmatter.pubDate).toISOString()
		: undefined,
	authors: frontmatter.author ? [frontmatter.author] : undefined,
	tags: frontmatter.tags,
};
---

<Searchable
	title={frontmatter.title}
	description={frontmatter.description}
	image={frontmatter.image}
	article={article}
	class="blog-layout"
>
	<Header
		title={frontmatter.title}
		description={frontmatter.description}
		date={new Date(frontmatter.pubDate)}
		minutesRead={minutesRead}
		author={frontmatter.author}
		editors={frontmatter.editors}
		tags={frontmatter.tags}
	/>

	<div class="blog-container">
		<Sidebar headings={headings} />
		<main class="post-content">
			<slot />
		</main>
	</div>

	<script>
		function initScrollSpy() {
			const tocLinks = document.querySelectorAll(".article-toc a");
			const headings = document.querySelectorAll(
				"main h1[id], main h2[id], main h3[id], main h4[id]",
			);

			if (headings.length === 0 || tocLinks.length === 0) {
				return;
			}

			const observerOptions = {
				root: null,
				rootMargin: "-80px 0px -70% 0px",
				threshold: 0,
			};

			let activeId = "";

			const updateActiveLink = (id) => {
				tocLinks.forEach((link) => {
					link.classList.remove("active");
					const href = link.getAttribute("href");
					if (href === `#${id}`) {
						link.classList.add("active");
					}
				});
			};

			const observerCallback = (entries) => {
				entries.forEach((entry) => {
					if (entry.isIntersecting) {
						activeId = entry.target.id;
						updateActiveLink(activeId);
					}
				});
			};

			const checkIfAtBottom = () => {
				const scrollTop = window.scrollY
					|| document.documentElement.scrollTop;
				const scrollHeight = document.documentElement.scrollHeight;
				const clientHeight = document.documentElement.clientHeight;

				if (scrollTop + clientHeight >= scrollHeight - 50) {
					const lastHeading = headings[headings.length - 1];
					if (lastHeading && lastHeading.id !== activeId) {
						activeId = lastHeading.id;
						updateActiveLink(activeId);
					}
				}
			};

			const observer = new IntersectionObserver(
				observerCallback,
				observerOptions,
			);
			headings.forEach((heading) => observer.observe(heading));
			window.addEventListener("scroll", checkIfAtBottom, {
				passive: true,
			});
		}

		function initHeadingAnchors() {
			const anchorLinks = document.querySelectorAll(
				".post-content .heading-anchor",
			);

			anchorLinks.forEach((anchor) => {
				anchor.addEventListener("click", async (e) => {
					e.preventDefault();
					const href = anchor.getAttribute("href");
					if (href == null) {
						console.warn(`Detected null href in anchor: ${anchor}`);
						return;
					}

					const url = new URL(href, window.location.href);
					url.hash = href;

					try {
						await navigator.clipboard.writeText(url.toString());
						anchor.classList.add("copied");
						history.pushState(null, "", href);
						setTimeout(() => {
							anchor.classList.remove("copied");
						}, 1500);
						// eslint-disable-next-line  @typescript-eslint/no-unused-vars
					} catch (_err) {
						window.location.hash = href;
					}
				});
			});
		}


		function initBlogPost() {
			initScrollSpy();
			initHeadingAnchors();
		}

		if (document.readyState === "loading") {
			document.addEventListener("DOMContentLoaded", initBlogPost);
		} else {
			initBlogPost();
		}

		document.addEventListener("astro:page-load", initBlogPost);
	</script>
</Searchable>
